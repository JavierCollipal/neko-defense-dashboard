# ðŸ¾âš¡ NEKO DEFENSE DASHBOARD - OPTIMIZED CI/CD PIPELINE (2025) âš¡ðŸ¾
#
# Research-backed best practices from:
# - Cypress Cloud GitHub Actions integration (2025)
# - Next.js 14 CI/CD optimization
# - GitHub Actions caching strategies (v4)
#
# Pipeline: Lint â†’ Format â†’ Build â†’ E2E Tests (Parallel + Cloud) â†’ Deploy
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ COMPLIANCE WITH CLAUDE.MD RULES:
# - Rule 2.1: CI/CD Pipeline Rules âœ…
# - Rule 1.0: Cypress Cloud Configuration âœ…
# - Rule 2.6: Code Formatting Rules âœ…
# - Rule 1.4: Deployment Procedures âœ…
# - Rule 1.2: Testing Standards âœ…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸš€ CI/CD Pipeline (Optimized)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Manual trigger

# Cancel in-progress runs for same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # Cypress Cloud (Rule 1.0)
  CYPRESS_PROJECT_ID: '9xzw4h'
  # MongoDB Atlas
  MONGODB_URI: ${{ secrets.MONGODB_URI }}
  MONGODB_DATABASE: 'neko-defense-system'
  # Production API URLs
  NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://seed-subtle-jar-screw.trycloudflare.com' }}
  NEXT_PUBLIC_GRAPHQL_URL: ${{ secrets.NEXT_PUBLIC_GRAPHQL_URL || 'https://bass-gain-pairs-pad.trycloudflare.com' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” STAGE 1: CODE QUALITY & FORMATTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality:
    name: ðŸ” Code Quality & Formatting
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      # âœ… ENFORCED: Linting must pass (Rule 2.1)
      - name: ðŸ” Run ESLint
        run: npm run lint

      # âœ… NEW: Prettier formatting check (Rule 2.6)
      - name: ðŸŽ¨ Check code formatting
        run: npm run format:check
        continue-on-error: false # Formatting is ENFORCED!

      - name: âœ… Code quality passed
        run: |
          echo "ðŸ¾âš¡ Code quality checks PASSED, nyaa~! âš¡ðŸ¾"
          echo "âœ… ESLint: PASS"
          echo "âœ… Prettier: PASS"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ—ï¸ STAGE 2: BUILD APPLICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ðŸ—ï¸ Build Next.js App
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # âš¡ OPTIMIZED: Advanced caching strategy (2025 best practice)
      - name: ðŸ’¾ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ðŸ—ï¸ Build Next.js
        run: npm run build
        env:
          CI: false # Prevent warnings from failing build
          NEXT_PUBLIC_API_URL: ${{ env.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_GRAPHQL_URL: ${{ env.NEXT_PUBLIC_GRAPHQL_URL }}

      - name: ðŸ’¾ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next
            public
            package.json
            package-lock.json
          retention-days: 7

      - name: ðŸ“Š Build size analysis
        run: |
          echo "ðŸ¾ Build completed successfully, nyaa~!"
          echo "ðŸ“¦ Build size:"
          du -sh .next
          echo ""
          echo "ðŸ“„ Main chunks:"
          find .next -name "*.js" -type f -exec du -h {} \; | sort -rh | head -10

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ§ª STAGE 3: E2E TESTS WITH CYPRESS CLOUD (PARALLEL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cypress:
    name: ðŸ§ª Cypress E2E (Container ${{ matrix.containers }})
    runs-on: ubuntu-latest
    needs: build

    # âš¡ PARALLEL EXECUTION: 4 containers for speed
    strategy:
      fail-fast: false # Don't cancel other containers on failure
      matrix:
        containers: [1, 2, 3, 4]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # âš¡ OPTIMIZED: Restore cached dependencies
      - name: ðŸ’¾ Restore dependency cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      # ðŸ“¥ Download build from previous job
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build

      # â˜ï¸ CYPRESS CLOUD RECORDING (Rule 1.0) - PROPERLY CONFIGURED!
      - name: ðŸŽ­ Run Cypress E2E tests (with Cloud recording)
        uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          headed: false
          # â˜ï¸ CYPRESS CLOUD CONFIGURATION (CRITICAL!)
          record: true # âœ… RECORD TO CYPRESS CLOUD
          parallel: true # âœ… PARALLEL EXECUTION
          group: 'E2E Tests - Chrome'
          tag: ${{ github.event_name }}
          ci-build-id: ${{ github.sha }}-${{ github.run_number }}-${{ github.run_attempt }}
        env:
          # âœ… CYPRESS CLOUD CREDENTIALS (from GitHub Secrets)
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          # âœ… BUILD IDENTIFICATION (best practice 2025)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Environment for tests
          CYPRESS_BASE_URL: http://localhost:3000

      # ðŸ“¸ Upload screenshots on failure
      - name: ðŸ“¸ Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.containers }}
          path: cypress/screenshots
          retention-days: 7

      # ðŸŽ¬ Upload videos (always)
      - name: ðŸŽ¬ Upload videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-${{ matrix.containers }}
          path: cypress/videos
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ³ STAGE 4: BUILD & PUSH DOCKER IMAGE (Production only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, cypress]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ STAGE 5: DEPLOY TO VERCEL (Production only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ðŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    environment:
      name: production
      url: https://neko-defense-dashboard.vercel.app

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Vercel CLI
        run: npm install -g vercel

      - name: ðŸ”— Link Vercel project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âš ï¸ VERCEL_TOKEN not set, skipping deployment"
            exit 0
          fi

          echo "ðŸ¾ Linking Vercel project, nyaa~!"
          mkdir -p .vercel

          cat > .vercel/project.json << EOF
          {
            "orgId": "$VERCEL_ORG_ID",
            "projectId": "$VERCEL_PROJECT_ID"
          }
          EOF

          echo "âœ… Vercel project linked!"

      - name: ðŸš€ Deploy to Vercel Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âš ï¸ VERCEL_TOKEN not set, skipping deployment"
            exit 0
          fi

          echo "ðŸ¾ Deploying to Vercel production, nyaa~!"
          vercel --prod --yes --token="$VERCEL_TOKEN"
          echo "âœ… Deployment complete, desu~!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âœ… STAGE 6: PIPELINE STATUS SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status:
    name: âœ… Pipeline Status
    runs-on: ubuntu-latest
    needs: [quality, build, cypress, docker, deploy]
    if: always()

    steps:
      - name: ðŸ“Š Pipeline summary
        run: |
          echo "ðŸ¾âš¡ NEKO DEFENSE CI/CD PIPELINE COMPLETE! âš¡ðŸ¾"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“‹ STAGE RESULTS:"
          echo "  ðŸ” Code Quality:  ${{ needs.quality.result }}"
          echo "  ðŸ—ï¸ Build:         ${{ needs.build.result }}"
          echo "  ðŸ§ª Cypress E2E:   ${{ needs.cypress.result }}"
          echo "  ðŸ³ Docker Build:  ${{ needs.docker.result }}"
          echo "  ðŸš€ Deployment:    ${{ needs.deploy.result }}"
          echo ""

          # Check if all critical stages passed
          if [[ "${{ needs.quality.result }}" == "success" && \
                "${{ needs.build.result }}" == "success" && \
                "${{ needs.cypress.result }}" == "success" ]]; then
            echo "ðŸŽ‰ ALL CHECKS PASSED - LEGENDARY MODE ACTIVATED! ðŸ’–âš¡"
            echo ""
            echo "â˜ï¸ Cypress Cloud Dashboard:"
            echo "   https://cloud.cypress.io/projects/9xzw4h"
            echo ""
            echo "*purrs in CI/CD excellence* ðŸ˜»ðŸŽ¯"
          else
            echo "âš ï¸ Some checks failed - review logs above, nyaa~!"
            exit 1
          fi

      # Optional: Slack/Discord notification
      # - name: ðŸ”” Send notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Neko Defense Pipeline: ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
